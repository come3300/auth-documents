---
title: 第７回：バリデーションを実装
category: php
---

このパートでは、**共通バリデーション関数群**を`common/validation.php`にまとめ、ユーザー登録など複数の処理で再利用できる形にしていきます。

---

## 🎯 本パートの目標物

`common/validation.php` に、以下のような **共通バリデーション関数** を実装します。

- 空チェック
- 最小文字数チェック
- 最大文字数チェック
- メールアドレス形式チェック
- 半角英数字チェック
- メールアドレス重複チェック

> 📂 ディレクトリ構成
> 

```bash
common/
├── database.php
├── header.php
└── validation.php ←★今回作成
```

---

## 🛠️ 作成の流れ

1. `validation.php` ファイルを作成
2. 各バリデーション関数を記述
3. 関数ごとに動作や処理内容を確認

---

## 🧩 バリデーション関数一覧

---

### ① 空チェック関数

```php
/**
 * 空チェック
 */
function emptyCheck(&$errors, $check_value, $message){
    if (empty(trim($check_value))) {
        array_push($errors, $message);
    }
}
```

### ✅ 解説

- `trim()`：前後の空白を除去
- `empty()`：値が空かどうかを判定
- `&$errors`：参照渡し。呼び出し元でエラーメッセージを蓄積できる

---

### ② 最小文字数チェック

```php
/**
 * 最小文字数チェック
 */
function stringMinSizeCheck(&$errors, $check_value, $message, $min_size = 8){
    if (mb_strlen($check_value) < $min_size) {
        array_push($errors, $message);
    }
}
```

### ✅ 解説

- `mb_strlen()`：マルチバイト文字の長さを取得（日本語対応）
- デフォルトの最小文字数は **8文字**

---

### ③ 最大文字数チェック

```php
/**
 * 最大文字数チェック
 */
function stringMaxSizeCheck(&$errors, $check_value, $message, $max_size = 255) {
    if ($max_size < mb_strlen($check_value)) {
        array_push($errors, $message);
    }
}
```

### ✅ 解説

- 最大長を超えた場合にエラーメッセージを追加
- デフォルトの最大長は **255文字**

---

### ④ メールアドレス形式チェック

```php
/**
 * メールアドレス形式チェック
 */
function mailAddressCheck(&$errors, $check_value, $message) {
    if (filter_var($check_value, FILTER_VALIDATE_EMAIL) == false) {
        array_push($errors, $message);
    }
}
```

### ✅ 解説

- `filter_var(..., FILTER_VALIDATE_EMAIL)` で形式をチェック
- 正しくない場合は false が返される

---

### ⑤ 半角英数字チェック

```php
/**
 * 半角英数字チェック
 */
function halfAlphanumericCheck(&$errors, $check_value, $message) {
    if (preg_match("/^[a-zA-Z0-9]+$/", $check_value) == false) {
        array_push($errors, $message);
    }
}
```

### ✅ 解説

- `preg_match()` で正規表現チェック
- `^[a-zA-Z0-9]+$` は「半角英数字のみ」を意味する

---

### ⑥ メールアドレス重複チェック

```php
/**
 * メールアドレス重複チェック
 */
function mailAddressDuplicationCheck(&$errors, $check_value, $message) {
    $database_handler = getDatabaseConnection();
    if ($statement = $database_handler->prepare('SELECT id FROM users WHERE email = :user_email')) {
        $statement->bindParam(':user_email', $check_value);
        $statement->execute();
    }

    $result = $statement->fetch(PDO::FETCH_ASSOC);
    if ($result) {
        array_push($errors, $message);
    }
}
```

### ✅ 解説

- `users` テーブルに同じメールアドレスが存在するかチェック
- 取得できたら重複と判断してエラー追加
- DB接続は `getDatabaseConnection()`（database.php）を使用

> ⚠️ validation.php 自体では database.php を require していません。
> 
> 
> 呼び出し元で読み込まれる前提で構成されています。
> 

---

## 📌 重複チェックで使われたSQL

```sql
SELECT id FROM users WHERE email = :user_email
```

- `SELECT`：取得対象のカラム
- `FROM`：対象テーブル
- `WHERE`：絞り込み条件

---

## ✅ まとめ

これで、以下の共通バリデーション関数が完成しました。