---
title: 第９回：ログイン機能追加
category: php
---

## 🎯本パートのゴール

- ログイン処理の実装
- ログイン画面へのバリデーション追加
- セッション管理でユーザー情報を保持

---

## 🗂️ディレクトリ構成

```
login/
├── action/
│   └── login.php
└── index.php

```

---

## 📝login.php の実装手順

### 1. 共通関数の読み込みとパラメータ取得

```php
<?php
session_start();
require '../../common/validation.php';
require '../../common/database.php';

// パラメータ取得
$user_email = $_POST['user_email'];
$user_password = $_POST['user_password'];

```

### 2. バリデーション処理

```php
$_SESSION['errors'] = [];

// 空チェック
emptyCheck($_SESSION['errors'], $user_email, "メールアドレスを入力してください。");
emptyCheck($_SESSION['errors'], $user_password, "パスワードを入力してください。");

// 文字数チェック
stringMaxSizeCheck($_SESSION['errors'], $user_email, "メールアドレスは255文字以内で入力してください。");
stringMaxSizeCheck($_SESSION['errors'], $user_password, "パスワードは255文字以内で入力してください。");
stringMinSizeCheck($_SESSION['errors'], $user_password, "パスワードは8文字以上で入力してください。");

if (!$_SESSION['errors']) {
    mailAddressCheck($_SESSION['errors'], $user_email, "正しいメールアドレスを入力してください。");
    halfAlphanumericCheck($_SESSION['errors'], $user_password, "パスワードは半角英数字で入力してください。");
}

if ($_SESSION['errors']) {
    header('Location: ../../login/');
    exit;
}

```

---

## 🔐ログイン認証処理の実装

```php
$database_handler = getDatabaseConnection();
if ($statement = $database_handler->prepare('SELECT id, name, password FROM users WHERE email = :user_email')) {
    $statement->bindParam(':user_email', $user_email);
    $statement->execute();

    $user = $statement->fetch(PDO::FETCH_ASSOC);
    if (!$user || !password_verify($user_password, $user['password'])) {
        $_SESSION['errors'] = ['メールアドレスまたはパスワードが間違っています。'];
        header('Location: ../../login/');
        exit;
    }

    $_SESSION['user'] = [
        'name' => $user['name'],
        'id' => $user['id']
    ];

    header('Location: ../../memo/');
    exit;
}

```

---

## 🖥️login/index.php の修正

### 1. セッション開始

```php
<?php
session_start();
?>

```

### 2. formタグの修正

```html
<form method="post" action="./action/login.php">

```

### 3. エラー表示箇所の追加

```php
<?php
if (isset($_SESSION['errors'])) {
    echo '<div class="alert alert-danger" role="alert">';
    foreach ($_SESSION['errors'] as $error) {
        echo "<div>{$error}</div>";
    }
    echo '</div>';
    unset($_SESSION['errors']);
}
?>

```

---

## ✅動作確認チェックリスト

- 空欄のままログイン

![image.png](attachment:43822690-1aeb-40b4-9e96-4dab0db818c3:image.png)

- パスワードが8文字未満

![image.png](attachment:db1772a2-c6bb-4a4f-8fd1-89a758f82d98:image.png)

- メールアドレスの形式不正

![image.png](attachment:38e9ad0d-7242-4226-ba67-d8515a4c6f9b:image.png)

- 全角パスワード

![image.png](attachment:ff88ceee-b88b-4e6c-ab85-1d1a1b9d5ce0:image.png)

- 正しい情報でログイン

![image.png](attachment:c246859f-6ea9-4bc2-9d36-5ab8a06f0766:image.png)

- 存在しないメールアドレス

![image.png](attachment:5eadab44-ae0e-4967-bed3-1c6a4499b80b:image.png)

- パスワード間違い

![image.png](attachment:602c6a40-de2b-4c16-b4e6-e55c434b87b8:image.png)

---

## ✏️ユーザー登録処理にもセッション追加

```php
// 登録成功後に追加
$_SESSION['user'] = [
    'name' => $user_name,
    'id' => $database_handler->lastInsertId()
];

```

---

## 🔚まとめ

このパートでは、ログイン機能とそれに伴うバリデーション処理、セッション管理について実装しました。次はログイン済みユーザーのみがアクセス可能なページ制御などを実装していきます。