---
title: 🗑 第16回：メモ削除機能の実装
category: php
---

# 🗑 メモ削除機能を実装しよう

**メモ投稿画面の削除ボタンをクリックすると、選択中のメモが削除される**ようにします。

---

## 🎯 本パートの目標物

- メモを選択
- 削除ボタンをクリック
- **対象メモがデータベースから削除**され、画面上からも消えるようにする

![メモ削除機能](/images/documents/php-memo/step17/delete-memo.png)

> 💡 削除後は編集エリアに「メモを新規作成するか選択してください」というメッセージが表示されます。

---

## 🛠 実装の流れ

1. `memo/action` に `delete.php` ファイルを作成
2. `delete.php` にメモ削除処理を実装
3. 動作確認を行う

---

## 1) ファイルを作成する

`memo` ディレクトリ配下に `action/delete.php` を新規作成します。

```
├── memo
│   ├── action
│   │   ├── add.php
│   │   ├── delete.php   ← 新規追加
│   │   ├── select.php
│   │   └── update.php
│   └── index.php
```

---

## 2) メモ削除処理を実装する

### 📄 `memo/action/delete.php`

```php
<?php
require '../../common/auth.php';
require '../../common/database.php';

// ログインしていない場合はログイン画面へ
if (!isLogin()) {
    header('Location: ../login/');
    exit;
}

// メモIDとユーザーIDを取得
$edit_id = $_POST['edit_id'];
$user_id = getLoginUserId();

// データベース接続
$database_handler = getDatabaseConnection();

try {
    // メモ削除処理
    if ($statement = $database_handler->prepare(
        "DELETE FROM memos WHERE id = :edit_id AND user_id = :user_id"
    )) {
        $statement->bindParam(":edit_id", $edit_id);
        $statement->bindParam(":user_id", $user_id);
        $statement->execute();
    }
} catch (Throwable $e) {
    echo $e->getMessage();
    exit;
}

// セッション上の選択中メモを削除
unset($_SESSION['select_memo']);

// メモ投稿画面へリダイレクト
header('Location: ../../memo');
exit;
```

---

## **💡 コードの解説**

### **① 共通ファイルの読み込み**

```php
require '../../common/auth.php';
require '../../common/database.php';
```

→ ログイン判定や DB 接続の関数を使えるようにします。

---

### **② ログイン判定**

```php
if (!isLogin()) {
    header('Location: ../login/');
    exit;
}
```

→ 未ログイン状態で削除が実行されないようにチェック。

---

### **③ メモIDとユーザーIDの取得**

```php
$edit_id = $_POST['edit_id'];
$user_id = getLoginUserId();
```

→ 投稿フォームから送られた edit_id（メモID）とログイン中のユーザーIDを使用。

---

### **④ データベースから削除**

```php
if ($statement = $database_handler->prepare(
    "DELETE FROM memos WHERE id = :edit_id AND user_id = :user_id"
)) {
    $statement->bindParam(":edit_id", $edit_id);
    $statement->bindParam(":user_id", $user_id);
    $statement->execute();
}
```

🧩 SQLの意味

```sql
DELETE FROM memos WHERE id = :edit_id AND user_id = :user_id
```

- DELETE FROM で指定テーブルからデータを削除
- WHERE で削除対象を限定（メモID＋ユーザーID）

→ ログイン中のユーザーが自分のメモだけ削除できるようになります。

---

### **⑤ セッションの選択中メモ情報を削除**

```php
unset($_SESSION['select_memo']);
```

→ 選択中のメモ情報をクリアすることで、削除後は空の状態に。

---

### **⑥ メモ画面に戻る**

```php
header('Location: ../../memo');
exit;
```

→ 削除処理完了後、再びメモ一覧ページへリダイレクト。

---

## **3) 動作確認**

### **✅ 削除ボタンの呼び出し設定（すでに実装済）**

memo/index.php の削除ボタンには、すでに以下のコードが設定されています。

```php
<div id="memo-menu">
    <!-- formaction で ./action/delete.php を指定している -->
    <button type="submit" class="btn btn-danger" formaction="./action/delete.php">
        <i class="fas fa-trash-alt"></i>
    </button>
    <button type="submit" class="btn btn-success" formaction="./action/update.php">
        <i class="fas fa-save"></i>
    </button>
</div>
```

---

### **🧭 確認手順**

1. http://localhost:8080/memo にアクセス（ログイン状態で）
2. 一覧から任意のメモを選択
3. 右側の編集エリアで削除ボタン（🗑）をクリック
4. メモが一覧から削除され、右側に下記メッセージが表示される

![削除後の画面](/images/documents/php-memo/step17/after-delete.png)

> 💬 「メモを新規作成するか選択してください。」

![メモ削除確認](/images/documents/php-memo/step17/delete-confirmation.png)

---

## **✅ まとめ**

- delete.php でメモ削除処理を実装
- メモIDとユーザーIDを指定して、安全に削除
- 削除後はセッション情報をリセットし、画面を再表示
