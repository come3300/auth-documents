---
title: 🔐 第10回:認証情報の共通関数作成
category: php
---

# 🔐 PHPでログイン認証共通関数を作成する方法

このパートでは、ログイン状態の確認やユーザー情報の取得を行う**共通関数ファイル（`auth.php`）を作成します。これにより、アプリケーション全体でログインユーザーに関する処理を一元化できます。

---

## 🎯 目標

- `common/auth.php` ファイルを作成
- ログインチェック関数を定義
- ユーザー名とユーザーIDの取得関数を定義

---

## 🗂️ ディレクトリ構成

```bash
common/
├── auth.php        ← 今回作成するファイル
├── database.php
├── header.php
└── validation.php

```

---

## 📝 `auth.php`の作成

### 1. セッション開始の記述

```php
<?php

if (!isset($_SESSION)) {
    session_start();
}

```

`$_SESSION`が未定義の場合に `session_start()` を実行し、セッションの重複エラーを防ぎます。

---

### 2. ログインチェック関数

```php
/**
 * ログインしているかチェックする
 * @return bool
 */
function isLogin() {
    return isset($_SESSION['user']);
}

```

`$_SESSION['user']` に値があるかどうかでログイン状態を判断します。

---

### 3. ログインユーザー名の取得関数

```php
/**
 * ログインしているユーザーの表示用ユーザー名を取得
 * @return string
 */
function getLoginUserName() {
    if (isset($_SESSION['user'])) {
        $name = $_SESSION['user']['name'];

        if (mb_strlen($name) > 7) {
            $name = mb_substr($name, 0, 7) . "...";
        }

        return $name;
    }

    return "";
}

```

ユーザー名が長すぎる場合は「...」をつけて短縮表示する仕様です。

### 🧠 `mb_substr` の補足

```php
mb_substr('こんにちは世界', 0, 5); // => こんにちは

```

- 第1引数：文字列
- 第2引数：開始位置（0始まり）
- 第3引数：切り取る文字数

---

### 4. ログインユーザーIDの取得関数

```php
/**
 * ログインしているユーザーIDを取得する
 * @return int|null
 */
function getLoginUserId() {
    return $_SESSION['user']['id'] ?? null;
}

```

ログイン中であれば `id` を返し、そうでなければ `null` を返します。

---

## ✅ まとめ

| 関数名 | 概要 |
| --- | --- |
| `isLogin()` | ログイン状態をチェックする |
| `getLoginUserName()` | ログイン中のユーザー名を取得する |
| `getLoginUserId()` | ログイン中のユーザーIDを取得する |

これらの共通関数は、ログイン制限が必要なページや、ログインユーザーの表示に活用できます。次のステップではこれらの関数を使って、ページアクセス制限やヘッダーへの名前表示などを実装していきましょう。

---

他の共通処理（DB接続やバリデーション）と合わせて利用することで、アプリ全体のコードがより再利用可能でメンテナブルになります。
