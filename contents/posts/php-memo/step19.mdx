---
title: 🔄 第18回：ログイン時に最新のメモ選択を実装
category: php
---

# 🔄 ログイン時に「最新のメモ」を自動選択しよう

**ログイン直後にそのユーザーの「最終更新メモ」が自動で選択・表示**されるようにします。

いまのままだと、ログイン時に何も選ばれておらず編集エリアが空の状態なので、使い勝手を改善します。

---

## 🎯 本パートの目標物

- ログイン直後、**更新日が最も新しいメモ**が選択され、右側の編集エリアに表示される。

---

## 🛠 実装の流れ

1. `login/action/login.php` を開く
2. **認証成功後**の処理に「最新メモ取得 → セッションへ保存」を追加
3. 動作確認

---

## 1) 変更箇所

対象ファイル：`login/action/login.php`

**パスワード検証が成功したブロック**（`password_verify(...)` が `true` の分岐）に、以下のコードを追加します。

### 追加コード

```php
if (password_verify($user_password, $user['password'])) {
    // ユーザー情報保持
    $_SESSION['user'] = [
        'name' => $name,
        'id'   => $id
    ];

    // --------- ここから追加する -----------
    // 更新日が最新のメモ情報を保持
    if ($statement = $database_handler->prepare(
        "SELECT id, title, content
           FROM memos
          WHERE user_id = :user_id
          ORDER BY updated_at DESC
          LIMIT 1"
    )) {
        $statement->bindParam(":user_id", $id);
        $statement->execute();
        $result = $statement->fetch(PDO::FETCH_ASSOC);

        if ($result) {
            $_SESSION['select_memo'] = [
                'id'      => $result['id'],
                'title'   => $result['title'],
                'content' => $result['content']
            ];
        }
    }
    // --------- ここまで追加する -----------

    header('Location: ../../memo/');
    exit;
} else {
    // 以降は既存のエラーハンドリング
}
```

---

## 💡 処理のポイント

### クエリの意味

```sql
SELECT id, title, content
  FROM memos
 WHERE user_id = :user_id
 ORDER BY updated_at DESC
 LIMIT 1;
```

- user_id で **ログイン中ユーザーのメモに絞り込み**
- updated_at DESC で **更新日の降順**（最新が先頭）
- LIMIT 1 で **最新の 1 件だけ**取得

### **セッションへの格納**

```php
$_SESSION['select_memo'] = [
    'id'      => $result['id'],
    'title'   => $result['title'],
    'content' => $result['content'],
];
```

- メモ画面（memo/index.php）はこの `$_SESSION['select_memo']` を参照して、**右側の編集エリア**へ反映します。

### **最新メモが無い場合の考慮**

- まだ 1 件もメモが無いユーザーは `$result` が空になります。

  ⇒ select_memo は設定しないため、**「メモを新規作成するか選択してください」** のメッセージが表示（既存実装でOK）。

---

## **✅ 動作確認**

1. 一度 **ログアウト** する（/memo/action/logout.php もしくは右上ログアウトボタン）
2. http://localhost:8080/login/ にアクセスして **ログイン**
3. メモ一覧の **最上部（= 最終更新）** のメモが自動で選択され、**右側の編集エリア**に表示されることを確認

![最新メモが選択された状態](/images/documents/php-memo/step19/latest-memo-selected.png)

> メモが複数ある場合、
>
> **更新ボタンで更新したメモほど上に来る**

---

## **🧩 トラブルシュート（簡易）**

- **常に未選択のまま**
  - そのユーザーにメモが 1 件も無い可能性。memos テーブルにデータがあるか確認。
- **別ユーザーのメモが選ばれる**
  - クエリの WHERE user_id = :user_id と bindParam(":user_id", $id) を再確認。
- **更新しても順番が変わらない**
  - update.php で updated_at = NOW() を更新しているか確認。

---

## **🎉 まとめ**

- 認証成功時に **最新メモを 1 件取得** して `$_SESSION['select_memo']` へ保存
- **ログイン直後から編集に移れる** 操作の最短化を実現
- 既存の表示ロジックに自然に乗るため、**画面側の変更は不要**

これで、ログイン直後のユーザー体験がグッと良くなりました！
