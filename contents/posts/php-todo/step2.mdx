---
title: 📝 第2回：TODOの追加機能を作ろう
category: php
---

## **🎯 今回の目標**

- HTMLフォームからTODOを追加できるようにする
- 入力されたTODOをセッションに保存する
- .htaccess + ルーティングでURL設計をスッキリさせる

---

## **📁 プロジェクト構成**

```
todo-app/
├── docker-compose.yml
├── php/
│   ├── Dockerfile
│   ├── public/
│   │   ├── .htaccess          ← 追加：Apacheのルーティング設定
│   │   └── index.php          ← 全ルーティングを処理するフロントコントローラ
│   ├── todo/
│   │   ├── index.php          ← 一覧表示処理
│   │   └── add.php            ← TODO追加処理
│   └── views/
│       └── todo.php           ← HTML表示テンプレート
```

---

## **✅ Dockerfile（DocumentRootと.htaccessの有効化）**

```
FROM php:8.2-apache

# DocumentRoot を public に変更
RUN sed -i 's!/var/www/html!/var/www/html/public!g' /etc/apache2/sites-available/000-default.conf

# AllowOverride All を追加（.htaccess 有効化）
RUN echo '<Directory /var/www/html/public>\n\
    AllowOverride All\n\
</Directory>' >> /etc/apache2/apache2.conf

# mod_rewrite を有効化
RUN a2enmod rewrite

# ソースコードを配置
COPY . /var/www/html/
```

---

## **✅ public/.htaccess（新規作成）**

```
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.php [QSA,L]
```

すべてのリクエストを index.php に集約し、そこでルーティング処理を行います。

---

## **✅ public/index.php（ルーター）**

```
<?php

$uri = rtrim(parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH), '/');
$method = $_SERVER['REQUEST_METHOD'];

if ($uri === '' || $uri === '/index') {
    require_once __DIR__ . '/../todo/index.php';
} elseif ($uri === '/add' && $method === 'POST') {
    require_once __DIR__ . '/../todo/add.php';
} else {
    http_response_code(404);
    echo '404 Not Found';
}
```

---

## **✅ todo/index.php（一覧表示）**

```
<?php
session_start();

if (!isset($_SESSION['todos'])) {
    $_SESSION['todos'] = [];
}

$todos = $_SESSION['todos'];

require_once __DIR__ . '/../views/todo.php';
```

---

## **✅ todo/add.php（追加処理）**

```
<?php
session_start();

$task = $_POST['task'] ?? '';

if (trim($task) !== '') {
    $_SESSION['todos'][] = $task;
}

header('Location: /');
exit;
```

---

## **✅ views/todo.php（表示とフォーム）**

```
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>TODOアプリ</title>
</head>
<body>
    <h1>TODOリスト</h1>

    <form action="/add" method="POST">
        <input type="text" name="task" placeholder="やることを入力" required>
        <button type="submit">追加</button>
    </form>

    <h2>やること一覧</h2>
    <ul>
        <?php foreach ($todos as $todo): ?>
            <li><?= htmlspecialchars($todo, ENT_QUOTES, 'UTF-8') ?></li>
        <?php endforeach; ?>
    </ul>
</body>
</html>
```

---

## **✅ 実行手順**

1. Dockerを再ビルド・再起動

```
docker compose down
docker compose up --build -d
```

1. ブラウザでアクセス：

```
http://localhost:8000
```

1. フォームにタスクを入力 → 「追加」ボタンを押す
2. ページがリロードされて、TODOリストに表示されていれば成功 🎉

---

## **✅ まとめ**
